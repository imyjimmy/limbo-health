# Base docker-compose configuration
# This file defines the core services shared across environments

services:
  admin-frontend:
    build: ./admin
    container_name: ${CONTAINER_PREFIX}_admin_frontend_1
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV}

  patient-frontend:
    build: ./patient
    container_name: ${CONTAINER_PREFIX}_patient_frontend_1
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV}

  mgit-api:
    build:
      context: .                    # Root context (to access mgit/ submodule)
      dockerfile: apps/mgit-api/Dockerfile  # Dockerfile location
    container_name: ${CONTAINER_PREFIX}_mgit_api_1
    volumes:
      - ./private_repos:/repos  # ADD THIS - mount your repos
      - ./users:/app/users      # ADD THIS - mount user data
    depends_on:
      - mysql
    restart: unless-stopped

  gateway:
    build: ./gateway
    container_name: ${CONTAINER_PREFIX}_gateway_1
    environment:
      - CONTAINER_PREFIX=${CONTAINER_PREFIX}
    restart: unless-stopped
    depends_on:
      - mgit-api
      - scheduler-api

  mysql:
    image: mysql:8.0
    container_name: ${CONTAINER_PREFIX}_mysql_1
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-password}
      MYSQL_DATABASE: limbo_health
      MYSQL_USER: ${MYSQL_USER:-user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./apps/scheduler-api/db:/docker-entrypoint-initdb.d

  phpmyadmin:
    image: phpmyadmin:5.2.1
    container_name: ${CONTAINER_PREFIX}_plebdoc_phpmyadmin_1
    environment:
      - PMA_HOST=${CONTAINER_PREFIX}_plebdoc_mysql_1
      - UPLOAD_LIMIT=102400K
      - PMA_USER=user
      - PMA_PASSWORD=password
    depends_on:
      - mysql
    restart: unless-stopped

  scheduler-api:
    build:
      context: .
      dockerfile: apps/scheduler-api/Dockerfile
    container_name: ${CONTAINER_PREFIX}_scheduler_api_1
    depends_on:
      - mysql
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - DB_NAME=limbo_health
      - DB_USER=${MYSQL_USER:-user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-password}
      - DB_PORT=3306
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
    volumes:
      - ./apps/scheduler-api/uploads:/app/uploads

  # plebdoc-api:
  #   build: ../plebdoc-scheduler-service/api
  #   container_name: ${CONTAINER_PREFIX}_plebdoc_api_1
    # environment:
    #   - NODE_ENV=${NODE_ENV}
    #   - JWT_SECRET=${JWT_SECRET}
    #   - NWC_CONNECTION_STRING=${NWC_CONNECTION_STRING}
    #   - ADMIN_NOSTR_PRIVATE_KEY=${ADMIN_NOSTR_PRIVATE_KEY}
    #   - DB_HOST=${CONTAINER_PREFIX}_plebdoc_mysql_1
    #   - DB_USER=user
    #   - DB_PASSWORD=password
    #   - DB_NAME=easyappointments
    #   # Google OAuth
    #   - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
    #   - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
    #   - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI}
    #   - GOOGLE_REDIRECT_URI_ADMIN=${GOOGLE_REDIRECT_URI_ADMIN}
    # depends_on:
    #   - mysql
    # restart: unless-stopped

  swagger-ui:
    image: swaggerapi/swagger-ui:latest
    container_name: ${CONTAINER_PREFIX}_plebdoc_swagger_1
    environment:
      - SWAGGER_JSON_URL=http://localhost:3005/api-docs.json
      - API_URL=http://localhost:3005/api-docs.json
    depends_on:
      - scheduler-api
    restart: unless-stopped

volumes:
  mysql_data:
  repos_data: